"use strict";(globalThis.webpackChunkvknext=globalThis.webpackChunkvknext||[]).push([[4064],{74732:(e,t,a)=>{a.d(t,{A:()=>i});var n=a(35277);const r=async(e,t)=>{const a=await(0,n._)({url:e,filename:t,type:"convertM3u8ToMp4"});return new File([a],t,{type:"video/mp4"})};var s=a(36008);const i=async(e,t)=>(await s.default.sendMessage("vkn-b-aath",new URL(e).origin+"/*"),await r(e,t))},21089:(e,t,a)=>{a.d(t,{A:()=>M});var n=a(14692);const r=async e=>{const{event:t,audio:a,lastModified:r,signal:s,path:i}=e;if(s?.aborted)return null;if(!a.url)return null;const o={id:a.id,owner_id:a.ownerId,url:a.url,title:a.title,access_key:a.accessKey,artist:a.artist,album_id:a.albumId,album_part_number:a.albumPartNumber,duration:a.duration,subtitle:a.subtitle};try{const e=await(0,n.G)({audio:o,signal:s});t.progress=(t.progress||0)+1;return{name:`${i}${(()=>{if(a.title){let e=a.title;return a.subtitle&&(e+=` (${a.subtitle})`),a.artist&&(e+=` - ${a.artist}`),e}return`audio${a.ownerId}_${a.id}`})()}.mp3`,lastModified:r,input:e}}catch(e){return console.error(e),null}},s=async e=>{const{event:t,doc:a,lastModified:n,signal:r,path:s}=e;if(r?.aborted)return null;if(!a.url)return null;try{const e=new URL(a.url);"0"===e.searchParams.get("no_preview")&&e.searchParams.set("no_preview","1");const i=await fetch(e,{signal:r}),o=await i.arrayBuffer();t.progress=(t.progress||0)+1;return{name:`${s}${a.title?a.title:`doc${a.ownerId}_${a.id}.jpg`}`,lastModified:a.date?new Date(a.date):n,input:new Blob([o])}}catch(e){return console.error(e),null}},i=async e=>{const{event:t,graffiti:a,lastModified:n,signal:r,path:s}=e;if(r?.aborted)return null;if(!a.imageUrl)return null;try{const e=new URL(a.imageUrl),i=await fetch(e,{signal:r}),o=await i.arrayBuffer();return t.progress=(t.progress||0)+1,{name:`${s}${e.pathname.slice(1)}.jpg`,lastModified:n,input:new Blob([o])}}catch(e){return console.error(e),null}};var o=a(35584);const l=async e=>{const{event:t,miniApp:a,lastModified:n,signal:r,message:s,path:i}=e;if(r?.aborted)return null;const l=a?.images;if(!l)return null;const c=(0,o.A)(l,512)?.url;if(!c)return null;try{const e=await fetch(c,{signal:r}),o=await e.arrayBuffer();t.progress=(t.progress||0)+1;const l=a.title?a.title:`miniapp${a.id}`,d=s.updatedAt?s.updatedAt:s.sentAt;return{name:`${i}${l}.jpg`,lastModified:d?new Date(d):n,input:new Blob([o])}}catch(e){return console.error(e),null}},c=async e=>{const{event:t,miniAppWidget:a,lastModified:n,signal:r,message:s,path:i}=e;if(r?.aborted)return null;const o=a?.app;if(!o)return null;const l=o.icon576||o.icon278||o.icon240||o.icon160||o.icon150||o.icon139||o.icon80||o.icon75;if(!l)return null;try{const e=await fetch(l,{signal:r}),a=await e.arrayBuffer();t.progress=(t.progress||0)+1;const c=o.title?o.title:`miniappWidget${o.id}`,d=s.updatedAt?s.updatedAt:s.sentAt;return{name:`${i}${c}.jpg`,lastModified:d?new Date(d):n,input:new Blob([a])}}catch(e){return console.error(e),null}};var d=a(82050);const u=async e=>{const{event:t,photo:a,lastModified:n,signal:r,path:s}=e;if(r?.aborted)return null;if(!a.originalImage)return null;try{const e=await fetch(a.originalImage,{signal:r}),i=await e.arrayBuffer();t.progress=(t.progress||0)+1;return{name:`${s}${[a.ownerId,a.id].join("_")}.jpg`,lastModified:a.uploadDate?new Date(a.uploadDate):n,input:new Blob([i])}}catch(t){return console.error(t),await(0,d.A)(1e3),await u(e)}},p=u,g=async e=>{const{event:t,poll:a,lastModified:n,signal:r,message:s,path:i}=e;if(r?.aborted)return null;const l=a?.backgroundPhoto?.image;if(!l)return null;const c=(0,o.A)(l,2e5)?.url;if(!c)return null;try{const e=await fetch(c,{signal:r}),o=await e.arrayBuffer();t.progress=(t.progress||0)+1;const l=a.title?`${a.title}.jpg`:`poll${a.ownerId}_${a.id}.jpg`,d=s.updatedAt?s.updatedAt:s.sentAt;return{name:`${i}${l}`,lastModified:d?new Date(d):n,input:new Blob([o])}}catch(e){return console.error(e),null}},f=async e=>{const{event:t,sticker:a,lastModified:n,signal:r,message:s,path:i,isDark:l=!1}=e;if(r?.aborted)return null;const c=l?a?.item?.images_with_background:a?.item?.images;if(!c)return null;const d=(0,o.A)(c,512)?.url;if(!d)return null;try{const e=await fetch(d,{signal:r}),o=await e.arrayBuffer();t.progress=(t.progress||0)+1;const c=`sticker${a.id?a.id:l?"_":""}${l?"b":""}.png`,u=s.updatedAt?s.updatedAt:s.sentAt;return{name:`${i}${c}`,lastModified:u?new Date(u):n,input:new Blob([o])}}catch(e){return console.error(e),null}},h=async e=>{const{event:t,stickerPack:a,lastModified:n,signal:r,message:s,path:i}=e;if(r?.aborted)return null;const o=a?.iconUrl;if(!o)return null;try{const e=await fetch(o,{signal:r}),l=await e.arrayBuffer();t.progress=(t.progress||0)+1;const c=`${a.title}_${a.packId}.png`,d=s.updatedAt?s.updatedAt:s.sentAt;return{name:`${i}${c}`,lastModified:d?new Date(d):n,input:new Blob([l])}}catch(e){return console.error(e),null}};var w=a(88908),m=a(74732),b=a(99761);const v=async e=>{const{event:t,video:a,lastModified:n,signal:r,path:s}=e;if(r?.aborted)return null;if(a.files?.external)return null;const[i,o]=(0,b.A)(a.files),l=a.files.hls,c=i&&o>=240||i&&!l?i:l||null;if(!c)return null;const d=(0,w.A)(a.title?`${a.title}.mp4`:`video${a.ownerId}_${a.id}.mp4`);let u=!1;try{if(c===l)try{const e=await(0,m.A)(c,t.title);return t.progress=(t.progress||0)+1,{name:`${s}${d}`,lastModified:a.uploadDate?new Date(a.uploadDate):n,input:e}}catch(e){u=!0,console.error(e)}if(!i)return null;const e=await fetch(u?i:c,{signal:r}),o=await e.arrayBuffer();return t.progress=(t.progress||0)+1,{name:`${s}${d}`,lastModified:a.uploadDate?new Date(a.uploadDate):n,input:new Blob([o])}}catch(e){return console.error(e),null}},y=async e=>{const{event:t,voice:a,lastModified:n,signal:r,message:s,path:i}=e;if(r?.aborted)return null;const o=a.linkMp3||a.linkOgg,l=!!a.linkMp3;if(!o)return null;try{const e=await fetch(o,{signal:r}),c=await e.arrayBuffer();t.progress=(t.progress||0)+1;const d=`voice${a.ownerId}_${a.id}${l?".mp3":".ogg"}`,u=s.updatedAt?s.updatedAt:s.sentAt;return{name:`${i}${d}`,lastModified:u?new Date(u):n,input:new Blob([c])}}catch(e){return console.error(e),null}},$=async({message:e,attaches:t,event:a,signal:n,lastModified:o,path:d=""})=>{let u=[];for(const w of Object.values(t)){let t=w;for(const w of Array.isArray(t)?t:[t])if(w){switch(w.kind){case"Photo":u.push(p({photo:w,event:a,signal:n,lastModified:o,path:d}));break;case"VideoMessage":case"Video":u.push(v({video:w,event:a,signal:n,lastModified:o,path:d}));break;case"Doc":u.push(s({doc:w,event:a,signal:n,lastModified:o,path:d}));break;case"Poll":u.push(g({poll:w,event:a,signal:n,lastModified:o,message:e,path:d}));break;case"Audio":u.push(r({audio:w,event:a,signal:n,lastModified:o,path:d}));break;case"Graffiti":u.push(i({graffiti:w,event:a,signal:n,lastModified:o,path:d}));break;case"WallReply":{const t=await $({message:e,attaches:w.attaches,event:a,signal:n,lastModified:o,path:`${d}wallReply${w.ownerId}_${w.postId}_r${w.id}/`});u=u.concat(t);break}case"Wall":{const t=await $({message:e,attaches:w.attaches,event:a,signal:n,lastModified:o,path:`${d}wall${w.ownerId}_${w.id}/`});u=u.concat(t);break}case"StickerPack":u.push(h({message:e,stickerPack:w,event:a,signal:n,lastModified:o,path:d}));break;case"Sticker":u.push(f({message:e,sticker:w,event:a,signal:n,lastModified:o,path:d,isDark:!1}),f({message:e,sticker:w,event:a,signal:n,lastModified:o,path:d,isDark:!0}));break;case"Voice":u.push(y({message:e,voice:w,event:a,signal:n,lastModified:o,path:d}));break;case"MiniApp":u.push(l({message:e,miniApp:w,event:a,signal:n,lastModified:o,path:d}));break;case"MiniAppWidget":u.push(c({message:e,miniAppWidget:w,event:a,signal:n,lastModified:o,path:d}));break;default:console.warn("[downloadMessageAttaches] unknown kind",{value:w})}if(a.progressTotal=(a.progressTotal||0)+u.length,u.length%20==0)try{await Promise.all(u)}catch(e){console.error(e)}}else console.warn("[downloadMessageAttaches] value is undefined",{message:e,value:w})}return u},M=$},49357:(e,t,a)=>{a.a(e,(async(e,n)=>{try{a.d(t,{default:()=>d});var r=a(88908),s=a(93819),i=a(67078),o=a(88298),l=a(21089),c=e([o]);o=(c.then?(await c)():c)[0];const d=async e=>{const t=new AbortController,{signal:n}=t,c=new Date,d=await s.A,u=new o.j({icon:"attach",title:(0,r.A)(`${e.peerId}_${e.cmid}.zip`),subtitle:d.use("vkcom_downloading"),onCancel:()=>t.abort()}),p=o.N.addEvent(u);let g=[];if(e.attaches)try{g=await(0,l.A)({message:e,attaches:e.attaches,event:u,signal:n,lastModified:c})}catch(e){console.error(e)}for(const t of e.forwardedMessages||[])try{const e=await(0,l.A)({message:t,attaches:t.attaches,event:u,signal:n,lastModified:c});g=g.concat(e)}catch(e){console.error(e)}const f=(await Promise.all(g)).filter(Boolean);if(!n.aborted){if(0===f.length)return p(),void await(0,i.A)({type:"error",text:d.use("global_not_found")});if(1===f.length){const e=f[0],t=URL.createObjectURL(e.input);await o.N.downloadFileFromLink(t,e.name),URL.revokeObjectURL(t)}else{const{downloadZip:e}=await a.e(1941).then(a.bind(a,71941)),t=await e(f).blob(),n=URL.createObjectURL(t);await o.N.downloadFileFromLink(n,u.title),URL.revokeObjectURL(n)}p()}};n()}catch(e){n(e)}}))},99761:(e,t,a)=>{a.d(t,{A:()=>n});const n=e=>{const t=Object.keys(e).filter((e=>e.startsWith("mp4_")));t.sort(((e,t)=>{const a=parseInt(e.split("_")[1]);return parseInt(t.split("_")[1])-a}));for(const a of t)if(e[a])return[e[a],Number(a.split("_")[1])];return[null,null]}},35584:(e,t,a)=>{a.d(t,{A:()=>n});const n=(e,t,a=null)=>{if(!Array.isArray(e)||0===e.length)return null;const n=[...e].sort(((e,t)=>e.width<t.width?-1:e.width>t.width?1:e.height<t.height?-1:e.height>t.height?1:0)),r=n.filter((e=>e.width>=t));if(0===r.length)return n[n.length-1];if(!a)return r[0];for(let e=0;e<r.length;e++){const t=r[e];if(t.height>=a)return t}const s=r.sort(((e,t)=>t.height-e.height));return s[s.length-1]}}}]);