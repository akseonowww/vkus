"use strict";(globalThis.webpackChunkvknext=globalThis.webpackChunkvknext||[]).push([[7478,1691,367,1243],{53060:(e,t,s)=>{s.d(t,{A:()=>o});var a=s(95728);const o=(e,t)=>{for(const s of document.querySelectorAll(".ConvoMessage,.ConvoMessageWithoutBubble")){const{fiber:o}=(0,a.A)(s),r=o?.return?.memoizedProps?.message;if(r&&(r.peerId===e&&r.cmid===t))return s}return null}},62965:(e,t,s)=>{s.d(t,{A:()=>c});var a=s(387),o=s(40367),r=s(43024);let n=null,i=[];const c=async(e,t)=>{if("page"!==r.default.getValue("messagesSaveMode"))return;if(10002!==e[0])return;const s=e[4],c=e[2],u=t.getState().ownerId;if(!(131072&c))return;if(!r.default.getValue("nodeleteall"))return;const l=(0,a.A)();i.push([u,s,l]),n||(n=setTimeout((async()=>{try{await(async()=>{if(0===i.length)return;const e=await o.default.getStorage();for(const[t,s,a]of i){const o=e[t]||{};o[s]={time:a},e[t]=o}await o.default.saveStorage(e),i=[],n=null})()}catch(e){console.error("Ошибка при сохранении событий:",e)}}),3e3))}},94301:(e,t,s)=>{s.d(t,{A:()=>c});var a=s(4255),o=s(31691),r=s(43024);let n=null,i=[];const c=async(e,t)=>{if("page"!==r.default.getValue("messagesSaveMode"))return;if(10005!==e[0])return;const[s,c,u,l,g,d,f,h,w,m,p]=e,v=t.getState().ownerId;if(f?.is_expired)return;const y=a.A.isChatId(l)?Number(f?.from):2&u?v:l;let[S]=(await window.vkApi.api("messages.getById",{message_ids:[m]})).items;S||(S={id:m,random_id:w,conversation_message_id:c,text:d,date:g,update_time:p,peer_id:l,from_id:y,out:y===v?0:1});const M={kind:"NewMessage",...S};i.push([`${v}_${m}`,[M]]),n||(n=setTimeout((async()=>{try{await(async()=>{if(0===i.length)return;const e=await o.default.getStorage();for(const[t,s]of i)e[t]?e[t].push(...s):e[t]=s;await o.default.saveStorage(e),i=[],n=null})()}catch(e){console.error("Ошибка при сохранении событий:",e)}}),3e3))}},23804:(e,t,s)=>{s.d(t,{A:()=>g});var a=s(387),o=s(4255),r=s(32488),n=s(31691),i=s(21243),c=s(43024);let u=null,l=[];const g=async(e,t)=>{if(10004!==e[0])return;if("page"!==c.default.getValue("messagesSaveMode"))return;const s=c.default.getValue("nodeleteall"),g=c.default.getValue("hookBombs")&&await(0,r.default)(),d=c.default.getValue("showMessageHistory");if(!s&&!g&&!d)return;const f=e[1],h=e[2],w=e[3],m=e[4],p=e[5],v=e[6],y=e[7],S=e[9],M=t.getState().ownerId;if(y?.expire_ttl){const e=y.expire_ttl;if(g){const t=await i.default.getMessages(M,{}),s=(0,a.A)()+parseInt(e);t[w]={time:s},await i.default.setMessages(M,t)}}const A=o.A.isChatId(m)?Number(y?.from):2&h?M:m,_=`${M}_${w}`;let[k]=(await window.vkApi.api("messages.getById",{message_ids:[w]})).items;k||(k={id:w,random_id:S,conversation_message_id:f,text:v,date:p,peer_id:m,from_id:A,out:A===M?0:1});const b={kind:"NewMessage",src:1,...k};l.push([_,[b]]),u||(u=setTimeout((async()=>{try{await(async()=>{if(0===l.length)return;const e=await n.default.getStorage();for(const[t,s]of l)e[t]?e[t].push(...s):e[t]=s;await n.default.saveStorage(e),l=[],u=null})()}catch(e){console.error("Ошибка при сохранении событий:",e)}}),3e3))}},12225:(e,t,s)=>{s.d(t,{A:()=>r});var a=s(67992);const o=new Map,r=e=>{if(o.has(e))return o.get(e);const t=new a.A;return o.set(e,t),t}},51047:(e,t,s)=>{s.a(e,(async(e,a)=>{try{s.r(t);var o=s(57580),r=s(387),n=s(32488),i=s(2519),c=s(43024),u=s(91674),l=s(53060),g=s(37643),d=s(62965),f=s(94301),h=s(23804),w=s(12225),m=e([o]);o=(m.then?(await m)():m)[0];const p=({engine:e,store:t})=>{if(e._fetchHooked)return;e._fetchHooked=!0;const s=e.fetchMaster;e.fetchMaster=async function(...e){const a=await Reflect.apply(s,this,e),o=[],i=(0,r.A)();for(const e of a.updates){0;try{const[s]=e;switch(s){case 10004:{o.push(e),(0,h.A)(e,t).catch(console.error);const s=t.getState(),a=s.convos.get(e[4])?.push?.mode;if("everything"===a){const t=(0,w.A)(s.viewer.id);for(const s of t.listeners)try{s(e)}catch(e){console.error(e)}}break}case 10002:{(0,d.A)(e,t).catch(console.error);const[,s,a,r]=e;if(131072&a&&c.default.getValue("showDeletedMsg")){(0,u.m)(r,s,i);const e=(0,l.A)(r,s);e&&(0,g.A)(e,i)}else o.push(e);break}case 10019:if(c.default.getValue("showBombsMsg")&&await(0,n.default)()){const s=t.getState().convos.get(e[2])?.history?.confirmed,a=s&&s.find((({item:t})=>t?.cmid===e[1]));a?.item?.expireTTL||o.push(e)}else o.push(e);break;case 10005:(0,f.A)(e,t).catch(console.error),c.default.getValue("showBombsMsg")&&await(0,n.default)()&&e[6]?.expire_ttl||o.push(e);break;default:o.push(e)}}catch(e){console.error(e)}}return a.updates=o,a}},v=async()=>{p(await(0,i.A)())};0,c.default.onInited(v),a()}catch(e){a(e)}}))},31691:(e,t,s)=>{s.r(t),s.d(t,{default:()=>r});var a=s(53778);class o extends a.default{constructor(){super("StorageMessages",{lifetime:3e4})}async getMessages(e,t){const s=await this.getStorage();return e in s?s[e]:t}async setMessages(e,t){const s=await this.getStorage();s[e]=t,await this.saveStorage(s)}async removeMessages(e){const t=await this.getStorage();delete t[e],await this.saveStorage(t)}}const r=new o},40367:(e,t,s)=>{s.r(t),s.d(t,{default:()=>r});var a=s(53778);class o extends a.default{constructor(){super("VKNDeletedMessages",{lifetime:5e3})}async getMessages(e,t){const s=await this.getStorage();return e in s?s[e]:t}async setMessages(e,t){const s=await this.getStorage();s[e]=t,await this.saveStorage(s)}async removeMessages(e){const t=await this.getStorage();delete t[e],await this.saveStorage(t)}}const r=new o},21243:(e,t,s)=>{s.r(t),s.d(t,{default:()=>r});var a=s(53778);class o extends a.default{constructor(){super("VKNExpiredMessages",{lifetime:5e3})}async getMessages(e,t){const s=await this.getStorage();return e in s?s[e]:t}async setMessages(e,t){const s=await this.getStorage();s[e]=t,this.saveStorage(s)}async removeMessages(e){const t=await this.getStorage();delete t[e],this.saveStorage(t)}}const r=new o}}]);